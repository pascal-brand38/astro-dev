---
// Copyright (c) Pascal Brand
// MIT License

import { Leaflet, layerAllNames } from "astro-leaflet";

---


  <div class="select-layer-grid">
    <form class="select-layer-main-layers">
      {
        Object.keys(layerAllNames).map((name, index) => (
              <label class='select-layer-label' for={name}>
                <input type="radio" name="mainLayers" id={name} value={name} checked={index===0} />
                {name}
              </label>
          )
        )
      }
    </form>

    <form class="select-layer-layer-names">
      {
        Object.keys(layerAllNames).map((name) => {
          return (layerAllNames[name].names).map((layer) => (
              <label class='select-layer-label' for={layer.name}>
                <input type="radio" name="layername" id={layer.name} value={layer.name}} />
                {layer.name}
              </label>
          ))
        })
      }
    </form>
  </div>

  <div id="select-layer-description">
  </div>

  <div class="select-layer-command">
    &#60;Leaflet options=&#123;&#123; tileByName: "<span id="select-layer-command"> </span>" &#125;&#125;</span> /&#62;
  </pre>

  <Leaflet id='astro-leaflet-select' options={{
      center: [38.3709404,-97.6649989],
      zoom: 4,
      mapOptions: {
        zoomControl: false,
      }
    }}
  />


<style is:global>
  .select-layer-grid {
    display: grid;
    grid-template-columns: 1fr 3fr;
    gap: 8px;
  }

  .select-layer-main-layers, .select-layer-layer-names {
    border: 1px solid black;
    height: 30vh;
    overflow-y: scroll;
    font-size: 10px;
  }

  .select-layer-label {
    display: block;
  }
  .select-layer-label:hover {
    font-weight: 900;
  }
  .select-layer-label:has(input:checked) {
    background-color: lightgray;
    font-weight: 900;
  }

  .select-layer-not-visible {
    display: none;
  }

  .select-layer-grid input {
    display: none;
  }

  .select-layer-command {
    border: 1px solid black;
    background-color: lightgrey;
    font-size: 14px;
    margin-top: 14px;
  }
  #select-layer-command {
    font-weight: 900;
  }
  #select-layer-description {
    border: 1px solid black;
    background-color: lightgrey;
    font-size: 14px;
    margin-top: 14px;
    min-height: 32px;
  }
</style>

<script>
  import L from "leaflet"
  import type { Map } from "leaflet"
	import { getMapFromId, getLayerOptionsFromName, type LayerNamesType, layerAllNames, } from "astro-leaflet"

  const mainLayersRadios = document.querySelectorAll('input[name="mainLayers"]') as NodeListOf<HTMLInputElement>
  const layernameRadios = document.querySelectorAll('input[name="layername"]') as NodeListOf<HTMLInputElement>
  const commandEl = document.getElementById('select-layer-command')
  const descriptionEl = document.getElementById('select-layer-description')
  let map: Map | undefined = undefined

	window.onload = function() {
		map = getMapFromId('astro-leaflet-select')
    if (map) {
      L.control.zoom({
        position: 'bottomright'
      }).addTo(map);
    }

    // select Google&type=hybrid
    mainLayersRadios.forEach((radio: HTMLInputElement) => {
      if (radio.value === 'Google') {
        select(radio)
      }
    })
    layernameRadios.forEach((radio: HTMLInputElement) => {
      if (radio.value === 'Google&type=hybrid') {
        select(radio)
      }
    })
	}

  // from layerAllNames, create an object of value: description
  const correspNameDesc: { [ name: string ]: string | undefined } = {}
  Object.keys(layerAllNames).forEach((name) => {
    layerAllNames[name].names.forEach((layer) => {
      if (layer.desc) {
        correspNameDesc[layer.name] = layer.desc
      }
    })
  })

  mainLayersRadios.forEach((radio: HTMLInputElement) => {
    radio.addEventListener('change', () => {
      let firstFound = false
      layernameRadios.forEach(layernameRadio => {
        if (layernameRadio.value.startsWith(radio.value)) {
          layernameRadio.parentElement!.classList.remove("select-layer-not-visible");
          if (!firstFound) {
            select(layernameRadio)
            firstFound = true
          }
        } else {
          layernameRadio.parentElement!.classList.add("select-layer-not-visible");
        }
      })

      // console.log(`${radio.value} changed`);
    })
  })


  layernameRadios.forEach((radio: HTMLInputElement) => {
    radio.addEventListener('change', () => {
      if (map) {
        map.eachLayer(function (layer) {
          map!.removeLayer(layer);
        });

        let layerFromName = getLayerOptionsFromName(radio.value as LayerNamesType)
        const newLayer = L.tileLayer(layerFromName.tileLayer, layerFromName.options);
        map.addLayer(newLayer)

        commandEl!.innerHTML = radio.value
        descriptionEl!.innerHTML = correspNameDesc[radio.value] ? correspNameDesc[radio.value] : ''
        // console.log(`${radio.value} changed`);
        // console.log(`layer = ${layerFromName.tileLayer}`);
      }
    })
  });

  // select Google&type=hybrid by default
  function select(radio: HTMLInputElement) {
    let change = new Event('change');
    radio.checked = true
    radio.dispatchEvent(change);
  }


</script>
