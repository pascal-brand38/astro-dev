---
// Copyright (c) Pascal Brand
// MIT License
//
// Implementation of https://leafletjs.com/examples/mobile/ with astro-leaflet
//
// Differences:
// - skipping part of fullscreen

import {
  Leaflet,
  FitWorld,
  Locate,
} from "astro-leaflet";

---

<Leaflet id="map-mobile">
  <FitWorld />
  <Locate options={{ setView: true, maxZoom: 16 }} />
</Leaflet>

<script>
  import { getMapFromId } from "astro-leaflet"
  import { getAstroLeafletMarkerDefaultIcon } from "astro-leaflet/client"
  import L from "leaflet"

  window.addEventListener('load', () => {
    const map = getMapFromId('map-mobile')
    if (map) {
      function onLocationFound(e:any) {
        // fix leaflet bug: default icon not displayed in production
        // https://stackoverflow.com/questions/41144319/leaflet-marker-not-found-production-env/76454369#76454369
        // this is why the default icon has to be specified
        var radius = e.accuracy;
        L.marker(e.latlng, { icon: getAstroLeafletMarkerDefaultIcon() }).addTo(map!)
            .bindPopup("You are within " + radius + " meters from this point").openPopup();

        L.circle(e.latlng, { radius } ).addTo(map!)
      }
      map.on('locationfound', onLocationFound);

      function onLocationError(e:any) {
          console.log(e.message);
      }
      map.on('locationerror', onLocationError);
    }
  })

</script>
